# Clue Selection as a Decision Problem



```{r, include = FALSE}
source("_packages_used.R")
```

***

We draw out the implications of the causal model approach for clue selection strategies. We introduce a tool for generating an optimal decision tree for clue selection given.

***

Consider now the problem of determining what qualitative data to gather on a case. Evidently it makes sense to gather information on clues that have large probative value, but whether or not clues have probative value can depend on what clues have already been collected: Finding out that the Butler had no motive may be informative for the claim that he is innocent, but it may not be useful if you already know he had no opportunity. 

To motivate our thinking about clue-selection, consider again our running example with the free press and government removal. We can use this toy example to see, intuitively, how researchers may have a choice among observations that could be informative, and how the informativeness of an observation can depend on what is already known. In Figure \ref{fig:running}, we showed  how one can use the structural equations to provide a set of conditional causal graphs that let one see easily what caused what at different values of the exogenous nodes $S$ and $X$. Each of these plots graphs a particular context. We can thus readily see which collection of exogenous nodes constitutes---gives the answer to---a given query, or estimand.  Turning things around, we can also see, given a query, which nodes are informative about the probability that the query is true.^[With larger graphs, continuous variables, and more stochastic components, it may not be feasible to graph every possible context; but the strategy for inference remains the same.]  

FLAG: Where is the running example figure currently? Need to reference it.

FLAG: I'm having trouble getting the logical progression here. Seems somewhat broken in the sense that it's incomplete. Conceptually, we might think of informativeness situations as taking four possible forms of interest: a clue is always informative; never informative; informative only conditional on something else (obviously, what the something else is can vary); conditional only in the absence of something else. We seem to be covering always informative and conditionally uninformative. Seems odd not to also show always uninformative and informative only conditional on something else. But not sure if we can do this with this example.

For example, suppose that one can see that $Y=0$ but does not know the causal effect of $X$ on $Y$.  This is equivalent to saying that we know that we are in panel $A$, $B$, or $C$ but do not know which of these we are in. Would it be helpful to collect the clue $S$ if one has no other information? Defining the query in terms of root nodes, the question becomes  $S \stackrel{?}{=} 1$, or $P(S=1|X=0,Y=0)$; the difference between the contexts in the two panels is that $S=0$ when, and only when, $X=0$ causes $Y=0$. Given the structural equation for $S$, $P(S|X=0,Y=0) = P(S|X=0)$, and given independence of $X$ and $S$, $P(S=1|X=0)= \pi^S$ (the simple assignment propensity).  Figuring out $S$ *fully* answers the query.^[Graphically what is important is that $S$ is informative not because it is $d-$connected with $Y$, but because it is $d-$connected to the query variable---here, simply, to itself.]

We can also see instances in this example of  how existing data can make clues *uninformative*. Say one wanted to know if $X$ causes $C$ in a case. As we can see from inspection of the panels, this query is equivalent to asking whether $S=1$ (as $X$ causes $C$ only in those two panels ($B$ and $D$) where $S=1$). Data on $R$ is unconditionally informative about this query as $R$ is not $d-$separated from $S$. For example, $R=1$ implies $S=0$. However, if $C$ and $X$ are already known, then $R$ is no longer informative because $C$ and $X$ together *d*-separate $R$ from $S$.^[We can come to the same conclusion by reasoning with the graphs: if $X=0$ and $C=1$, we know we are in subfigure $A$ or $B$, and $X$ causes $C$ only in panel $B$. However, $R$ is of no help to us in distinguishing between the two contexts as it takes the same value in both graphs.]

The running example also lets us demonstrate how informative clues can be found in many different places in a graph. 

1. **Informative spouses** Spouses---parents of the same child---can inform on one another. As we have seen in other examples, when an outcome has multiple causes, knowing the value of one of those causes helps assess the effect(s) of the other(s). For example, here, $S$ and $X$ are both parents of $C$; $S$ is thus informative for assessing whether $X$ causes $C$. Indeed this query, written in terms of roots, is simply $P(S)$:  $X$ causes $C$ if and only if $S=1$. Likewise, $S$ causes $C$ (negatively) if and only if $X=1$. 

2. **Pre-treatment clues.** Did the absence of media reports on corruption ($R=0$) cause government survival ($Y=0$)? Look to the pre-treatment clue, $X$: $X=0$ is a smoking gun establishing that the absence of a report produced government survival. Or, substantively, if there were a free press, then a missing report would never be a cause of survival since it would occur only in the absence of corruption, which would itself be sufficient for survival. More broadly, this example illustrates how knowledge of selection into treatment can be informative about treatment effects. 

3. **Post-outcome clues.** Suppose we observe the presence of a free press ($X=1$) and want to know if it caused a lack of corruption ($C=0$), but cannot observe the level of corruption directly. Observing $Y$---which occurs after the outcome---is informative here: if $X=1$, then $X$ causes $C$ (negatively) if and only if $Y=0$. When an outcome is not observed, a consequence of that outcome can be informative about its value and, thus, about the effect of an observed suspected cause. 

4. **Mediators as clues**: We see a politically sensitive government ($S=1$) and its survival ($S=0$). Did the government survive because of its sensitivity to public opinion? Here, the mediation clue $C$ is helpful: a lack of corruption, $C=0$, is evidence of $S$'s negative effect on $Y$. 

And, of course, different clues can be  informative in different ways for different types of estimand.

Needed then is a systematic way for identifying what clues to look for for answering a given type of causal quesiton, given what we already know---and perhaps, in what order to look for them.

## A strategic approach

The representation of inference problems as one of querying a Bayesian model points to a relatively simple method for answering this question, at least for small problems. Consider, first, a situation in which one has access to data $W$ and wants to know the expected probative value of all possible collections of data one could gather. 

This can be done as follows:

1. Define the model. 
2. Define a query on the model.
3. Define a data strategy: a set of clues for which one might search (e.g., observe the value of $C$).
4. Given prior data, figure out the probability of different realizations of the new data, and for each possible realization calculate the posterior variance. Then calculate the *expected* posterior variance for the data strategy by taking an average of these variances, with weights given by the probability of observing the clue realization in question.
5. Repeat steps 3-4 for different data strategies. 

This procedure returns the expected posterior variances associated with different data strategies. 

A still more sophisticated strategy would, for multiple clues, take sequence into account: it would tell us which clues to search for later in the process given the realization of clues sought earlier. The path-dependence of clue selection arises from the possibility that the informativeness of a clue may depend on the value of other nodes in the model. A given clue $K_2$, for instance, may be informative if another clue $K_1$ has the value of 1 but not if it has the value 0. 

We provide tools for both of these approaches and illustrate them below for both the running example and the democracy application.

## Clue selection for the running example

Let's return to the running example and assess the informativeness of different clue strategies for different estimands. 

This model is formally defined in `gbiqq` as follows:

```{r ch11strategies_chunk_slowxx, warning = FALSE}
model <- 
  
  make_model("S -> C -> Y <- R <- X; X -> C -> R") %>%
  
  set_restrictions(labels = list(C = "C1110", R = "R0001", Y = "Y0001"), 
                   keep = TRUE) %>%
  
  set_priors()

```

As we have fully specified deterministic functional equations for this model, we restrict the nodal types to just those consistent with these functions. So, for instance, we restrict $C$'s nodal type to $\theta^C_{1110}$ because $C=1-XS$, meaning that it takes on a value of 1 unless both of its parents take on a value of 1 and takes on 0 otherwise. Similarly, the functional equation $R=CX$ implies the nodal type $\theta^R_{0001}$, with $R$ equal to 0 unless both of its parents are equal to 1. 

```{r, echo = FALSE, include = FALSE}
plot_dag(model)
```

Using this model we can ask how likely different data realizations are and what we would infer from each possible data realization, given existing data. We illustrate assuming we already know that $X=0$ and $Y=0$. 

```{r, echo = TRUE, message = FALSE, warning = FALSE, include = FALSE}
possible_inferences <-  
  
  conditional_inferences(model, 
                         query = list(COE = "(Y[X=1] > Y[X=0])"), 
                         given = "X==0 & Y==0")

```

Application of the function `conditional_inferences`  produces a matrix with the results. We reproduce these as Table \@ref(tab:showstrats5xx).


```{r showstrats5xx, echo = FALSE, warning = FALSE}
# colnames(possible_inferences)[1:2] <- c("Prior var", "Var given W")

kable(possible_inferences[possible_inferences$prob >0, ], caption="Inferences given different data patterns. ", row.names = FALSE)
```

Each inference has an associated posterior variance and so it is easy to assess the *expected* reduction in variance from seeking any kind of clue. See Table \@ref(tab:scxrylearning). 


```{r ch11ExpectedLearning, warning = FALSE, include = FALSE}

strats <- list("S", "C", "R", c("C", "R"), c("C", "S"), c("S", "R"), c("C", "S", "R"))

learning <- sapply(strats,  function(strategy) {

  expected_learning(model, 
                    query = list(COE = "(Y[X=1] > Y[X=0])"), 
                    strategy = strategy, 
                    given = "X==0 & Y==0", 
                    parameters = NULL)
  })
```


```{r scxrylearning, echo = FALSE}
kable(t(learning), col.names = c("Strategy", "Given", "Prior belief", "Prior Uncertainty", "Posterior Uncertainty"))
```


The implication of the analysis is that if we know $X=0$ and $Y=0$ and we are interested in finding out whether$X=0$ *because* $Y$ is 0 we should look for evidence on $S$. Given this simple model, knowledge of $S$ is enough to answer the question at hand and *no other information is useful at all*.


### Dynamic Strategies

The clue-collection strategies described above assume that researchers identify the full set of clues to be gathered in advance and do not alter their strategies as they go along. However, the expected informativeness of a clue may depend on the values of other clues that we see first, implying that an optimal strategy will be dynamic, taking into account earlier observations in selecting later ones. 

Given $n$ nodes, a dynamic data collection strategy will be of the form:
$$\sigma = \{K_1, (K_2|K_1 = 1), (K_2|K_1 = 0), (K_3|K_1=1, K_2 =0)\dots\}$$

where each $K_j$ is en element of the nodes on the graph, or is the empty set. Thus, we start with observing $K_1$; then, whether we choose to observe $K_2$ depends on the value of $K_1$; whether we choose to observe $K_3$ depends on the value of $K_1$ and (if we observed it) $K_2$; and so on. A strategy *vector* specifies a series of conditional clue-search actions: it identifies the first clue sought and then which clues are sought conditional on the realization of all prior clues sought.  

Each possible strategy has an associated expected reduction in variance as well as an associated expected cost. 

To illustrate with the running example we imagine a situation in which it is known that $Y=1$ and we are interested in whether $Y=0$ because of $S$ (though we don't know at the outset what the value of $S$ is). We consider strategies in which we first seek information on one node and then, conditional on what we find, we look for data on one other node (or not). With five nodes, one already known, there are $4 \times 4^2$ strategies of this form.

Suppose that we observe that $Y=0$: the government was not replaced. We then want to know whether this is because the government was sophisticated ($S=1$). If we learn that the government was not sophisticated, then this answers the question in the negative. If we learn that the government was sophisticated then we can infer that this was the cause if we learn that there was a free press (or if we learn that there was no corruption).

```{r, include = FALSE}

# A strategy is a triple that indicates (a) first node sought (b) action if first node is 0 (c) action if first node = 1
# This function calculates the expected posterior variance from each strategy and the expected number of clues sought

strategy_evaluation <- function(model, 
                                strategy  = c("X", "C", NA), 
                                given = "Y==0",  
                                query = "(Y[S=1] != Y[S=0])",
                                prices = NULL) {
  vars <- model$variables
  if(is.null(prices)) prices <- rep(1, length(vars))
  s1 <- strategy[[1]]
  
  # FLAG / HACK: Better to have this only look at relevant cases, not all data
  given_vars <- NULL
	if(!is.null(given)) {
			given_vars <- str_extract_all(given, boundary("word"))[[1]]
			given_vars <- given_vars[(given_vars %in% vars)]
			}
  na_vars <- vars[!(vars %in% unlist(c(s1, given_vars)))]
  given2 <- paste(given, paste(paste0(" & is.na(", na_vars, ")"), collapse = ""))
  
  # Conditional inferences
  ci  <- conditional_inferences(model, query = query, given = given2)
  
  # Step 1 conclusions depending on findings on strategy 1
    p0 <- filter(ci, ci[s1]==0)[1, c("posterior", "prob")]
    p1 <- filter(ci, ci[s1]==1)[1, c("posterior", "prob")]
    
    # Probability of finding 0/1 in step 1 (normalized)
    probs  <- c(p0$prob, p1$prob)/(p0$prob + p1$prob)
    
    # Gather posteriors
    posts <- c(p0$posterior, p1$posterior)
    
    evs <- 
      sapply(0:1, function(j){
      s <- strategy[[2+j]]
      ifelse(is.na(s), 
            (posts[1+j])*(1-posts[1+j]),
            expected_learning(model, 
                    query = query, 
                    strategy = paste(s), 
                    given = paste(given, "&", strategy[[1]], "==", j), 
                    parameters = NULL)$E_post_var)
    })
    
    # Flag: A little HACKY: Fill in NAs if probs = 0
    evs[probs == 0]  <- 0
    strategy[2:3][probs == 0]  <- "NONE"
    
    # Expected Number of clues sought: 1 plus 1 if additional steps sought
    expected_n        <- 1 + probs%*%as.vector((!is.na(strategy[2:3])))
    
    # Expected variance given conditional strategies
    expected_variance <- probs%*%evs  
    
    # Costs
    costs <- c(sum(prices[vars %in% factor(strategy[-3])]),     
               sum(prices[vars %in% factor(strategy[-2])]))
    expected_costs <- probs%*%costs  

    c(expected_n = expected_n, expected_variance = expected_variance, expected_costs = expected_costs)
}

# Make a list of strategies:
vars <- c("S", "X", "C", "R") 
strategy_list <- sapply(1:4, function(j) 
  expand.grid(one = vars[j], two_0 = c(NA, vars[-j]), two_1 = c(NA, vars[-j]), stringsAsFactors = FALSE), 
  simplify = FALSE)
strategy_list <- do.call("rbind", strategy_list)
strategy_list <- data.frame(strategy_list, stringsAsFactors = FALSE)

# Calculate expected n and variance
# Assume prices in wihch X and C are somewhat expensive
prices <- c(1, 1.5, 1.2, .5, .7)
# do_diagnosis <- TRUE
if(do_diagnosis){
results <- t(apply(strategy_list, 1, function(j) 
  strategy_evaluation(model, strategy  = j, given = "Y==0", prices = prices))) %>%
  data.frame()
  write_rds(results, "saved/ch11_tradeoffs.rds")
  }
results <- read_rds("saved/ch11_tradeoffs.rds")

out <- cbind(strategy_list, results)

#Best?
# out[17,]

## FLAG: CHECK NAS / WANRINGS
```


QUERY: Are the prices in the code out of order relative to the comment and the text below?

For each strategy we can then assess the expected variance reduction; in addition, if collecting different clues comes at different costs---but collection depends on past findings---then we can also calculate the expected costs of each strategy.


| Strategy | Step 1 | Step 2 if 0 | Step 2 if 1 | Expected variance | Expected Cost |
|----------|--------|-------------|-------------|-------------------|---------------|
| 1        | S      | None        | None        |       0.167       | 1             |
| 2        | S      | X           | X           |       0           | 2.5           |
| 3        | S      | None        | X           |       0           | 2             |
|          |        |             |             |                   |               |

Figure \@ref(fig:ch11tradeoffs) plots a collection of strategies based on two criteria---the variance reduction and the expected number of clues sought, which could be an indicator for cost. One can see a frontier of optimal strategies, depending on how these two desiderata trade-off against each other. For the figure, we imagined that $X$ is the most costly to collect, followed by $C$, then $S$, then $Y$, then $R$. The cheapest strategy among those that minimize variance involves gathering $C$ only. The lowest variance strategy that minimizes costs involves gathering $Y$ only.

FLAG: Think we need to label the strategies in graph somehow.


```{r ch11tradeoffs, echo = FALSE}
# Plot results
with(results, plot(expected_costs, expected_variance, main = "Tradeoffs over strategies"), xlab = "Expected costs of strategy", ylab = "Expected posterior variance from strategy")
```

  
## Clue selection for the Democracy model 

With a model in hand we are also in a position to assess what we *could* learn from different data stratgies and what we would infer upon discovery of different data. 


```{r, echo = FALSE}

model <- make_model("I -> M -> D <- P; I -> D") %>%
         set_restrictions(c(  
           "(M[I=1] < M[I=0])",
            "(D[I=1, M=., P=.] > D[I=0, M=., P=.])",
            "(D[M=1, I=., P=.] < D[M=0, I=., P=.])", 
            "(D[P=1, M=., I=.] < D[P=0, M=., I=.])"))

```

```{r, echo = FALSE}

inferences <-
  conditional_inferences(model, query = "D[I=1] > D[I=0]", given = "I==1 & D==1")

kable(inferences, caption = "\\label{possible_outcomes} Table shows possible data patterns for P and M given I = 1 and D = 1 together with the probability of observing each data realization given data is sought on a variable and the posterior given that data realization.", digits = 3)

```

We show in Table \ref{CaseLearn}  how  uncertainty is likely to be reduced with  different research designs. In this table, we show these reductions for the two kinds of cases in which democratization does occur. The first row displays the variance on our posterior belief about the effect of $I$ on $D$ before we observe anything at all. The second row shows what happens to that uncertainty when we observe just cause and outcome, $I$ and $D$. The next four rows show the results for four possible choices in regard to process tracing: looking for neither $M$ nor $P$ (which is identical to doing no process tracing at all); looking for $P$; looking for $M$; and looking for both. The clearest message here is that, if we had to choose between clues, we should observe $P$: given our model (including our priors on the types), we reduce our uncertainty more by learning about an alternative cause than by learning about a mediator. We also see that the mediator is much more informative when the causal effect we are looking for is one that *could* have operated via the mediator, as compared to when the mediator is informative only as a moderator of the cause's direct effects.




FLAG: Table \ref{CaseLearn} needs a column defining the strategies.

```{r, echo = FALSE}

EL1 <-
  rbind(
expected_learning(model, query = "D[I=0] == 0", strategy = NULL,       given = "I==1 & D==1"),
expected_learning(model, query = "D[I=0] == 0", strategy = "P",        given = "I==1 & D==1"),
expected_learning(model, query = "D[I=0] == 0", strategy = "M",        given = "I==1 & D==1"),
expected_learning(model, query = "D[I=0] == 0", strategy = c("P","M"), given = "I==1 & D==1"))

kable(EL1[,-1], caption = "\\label{CaseLearn}Variances and expected variances given different  clue seeking  stratgies for cases in which we have observed high inequality and democratization.", digits = 3)

```
FLAG: Are we merging these two tables? Have same label.

```{r, echo = FALSE}

EL2 <-
  rbind(
expected_learning(model, query = "D[I=1] == 0", strategy = NULL,       given = "I==0 & D==1"),
expected_learning(model, query = "D[I=1] == 0", strategy = "P",        given = "I==0 & D==1"),
expected_learning(model, query = "D[I=1] == 0", strategy = "M",        given = "I==0 & D==1"),
expected_learning(model, query = "D[I=1] == 0", strategy = c("P","M"), given = "I==0 & D==1"))

x_strategy <- c("None", "P", "M", "P and M")

kable(cbind(strategy = x_strategy, EL2[,-1]), caption = "\\label{CaseLearn}Variances and expected variances given different  clue seeking  stratgies for cases in which we have observed low inequality and democratization.", digits = 3)

```


```{r, echo = FALSE}

#Model with quant priors

model <- make_model("I -> M -> D <- P; I -> D") %>%
         set_restrictions(c(  
            "(D[I=1, M=., P=.] > D[I=0, M=., P=.])",
            "(D[M=1, I=., P=.] < D[M=0, I=., P=.])", 
            "(D[P=1, M=., I=.] < D[P=0, M=., I=.])")) %>%
  set_priors()



```




FLAG: applied case-level analyses involving causal pathways, actual causes, and notable causes.
For population-level estimands or is this redundant? See issue 53. 

FLAG: ADD DYNAMIC 
  
<!-- ## More complex problems -->

<!-- Illustration of clue inference for a continuous problem. -->

## Conclusion

Explicit statement of a causal model---including prior beliefs over roots---allows one to assess what will be inferred from all possible observations. This opens the way for simple strategies for assessing what data is most valuable, and in what order it should be gathered. 

We are conscious that here we are pushing the basic logic to the limits. In practice researchers will often find it difficult to describe a model in advance and to place beliefs on nodes. Moreover the collection of new data could easily give rise to possibilities and logics that were not previously contemplated. Nothing here seeks to deny these facts; the claim here is a simpler one: insofar as one can specify a model before engaging in data gathering, the model provides a powerful tool to assess what data is most useful to gather. 



