# Mixed-Method Application: Inequality and Democracy Revisited {#mixingapp}


```{r packagesused09, include = FALSE}
source("_packages_used.R")
do_diagnosis = FALSE
# options(mc.cores = parallel::detectCores())
```

:::: {.headerbox data-latex=""}
::: {.center data-latex=""}
:::
In Chapter \@ref(ptapp) we engaged in case-level inference about the effects of inequality on democracy using a model with fixed population-level parameters together with data from within the case. We now return to the inequality and democracy application but with a mixture of extensive and intensive data strategies: a combination of $I$ and $D$ data on a large number of cases together with mobilization data on a subset of those cases. We then use the updated model to draw both population-level and case-level inferences. We also complicate the model by allowing for the possibility that inequality is endogenous by building in unobserved confounding. The critical difference between the analyses in this chapter and those in Chapter \@ref(ptapp) is that, here, we update our beliefs over the population parameters, and not just over effects within the case. Thus, we can now simultaneously learn about our theory from cases and *use* our updated theory to draw case-level inferences. In other words, while our process tracing was entirely *theory*-informed, mixed-data inference is also *data*-informed. As we will see, the data-informed inferences are, on the whole, more uncertain than the theory-based inferences of Chapter 7.
::::
<br>



<!-- FLAG: Change causal types to unit types everywhere. -->

## A trained model

Whereas in Chapter \@ref(ptapp) we took the model as given and sought to draw inferences individual cases given data on those cases, the model now becomes an object that we both learn from and learn about. In essence we use the data on many cases to update our beliefs about the general model and then use this "trained" model to make inferences about cases. 

Along with this change in goals come some changes in the structure of the model:

* Instead of positing a belief about the causal type of a given case, $\theta$, we now need to posit a belief over the *distribution* of nodal types---that is, over $\lambda$. For instance, whereas in the simple process-tracing model we *specified* that inequality has a positive effect on mobilization for some share of units, we now specify a distribution over the proportion of units for which inequality could have a positive effect, ranging anywhere from 0 to 1. And we do the same for all other nodal types, with the proportions across types constrained to add up to 1 --- and, of course, for all nodes. Because we set a prior *distribution* over nodal types (rather than fixed proportions), we can now update on these population-level distributions as the model confronts data. 

The same applies to beliefs about confounding. Recall that we allow for unobserved confounding by allowing $\lambda$ to include beliefs about the *joint* distributions of nodal types, and we set priors on these joint distributions as well. In the application below, we focus on potential confounding in the relationship between inequality and mobilization: the possibility that inequality may be more or less likely in places where inequality would induce mobilization. Here we do not express informed prior beliefs about the direction or magnitude of such confounding; we set up the parameter matrix to allow for the possibility of confounding and set a flat prior over its direction and magnitude. We can, in turn, learn about confounding from the data.



We begin with the same basic model as we used in Chapter \@ref(ptapp), with inequality ($I$) potentially affecting democratization ($D$) both through a direct pathway and through an indirect pathway mediated by mobilization ($M$). International pressure ($P$) is also a "parent" of democratization. 

Further, we impose the same set of qualitative restrictions, ruling out a negative effect of inequality on mobilization, a direct positive effect of inequality on democratization, a negative effect of mobilization on democracy, and a negative effect of pressure on democratization. Note that this setup allows for inequality to have a positive (through mobilization) effect on democratization, a negative (direct) effect on democratization, or no effect at all. 

Finally, we allow for confounding. The theoretical intuition we want to instantiate in the model is that the level of inequality could be endogenous to inequality's effect on mobilization. In particular, in places where mobilization would pose a mobilizational threat, governments may work harder to reduce inequality. To allow for this possibility, we need to create distinct elements of $\lambda$ representing the conditional distribution of $I$'s nodal types given $M$'s: one parameter for $\theta^I$'s distribution when $M$'s nodal type is $\theta^M_{01}$, and another parameter for $\theta^I$'s distribution when $M$'s nodal type is something else. 




```{r model47, message = FALSE, echo = FALSE}
model <- make_model("I -> M -> D <- P; I -> D; I <-> M") %>% #Specify the DAG

         # Monotonicity restrictions
         set_restrictions(c( 
           "(M[I=1] < M[I=0])", 
           "(D[I=1] > D[I=0]) | (D[M=1] < D[M=0]) | (D[P=1] < D[P=0])"))
  
```


This model, with confounding, is represented graphically as in Figure \@ref(fig:pimdgraph). The possibility of confounding is represented with the bidirected edge, connecting $I$ and $M$. 


```{r pimdgraph, echo = FALSE, fig.cap="Democracy and Inequality Model"}
plot(model)
```



## Data

As in Chapter \@ref(ptapp), we will confront the model with data drawn from coding narratives in the Supplementary Material for @haggard2012inequality. However, rather than implementing the analysis case-by-case, we now derive leverage from the joint distribution of the data available across all cases. 

Table \@ref(tab:data82) gives a snapshot of the data.



```{r data82, echo = FALSE, warning = FALSE}
data <- CausalQueries::democracy_data 

#data <- read.csv("data/pimd2.csv") %>% 
#  mutate(I2 = I2*1) %>% select(country, P2, I2, M2, D2) %>%
#  rename(P = P2, I = I2, M= M2, D = D2)

kable(head(data), caption = "Data (snapshot) derived from Haggard and Kaufman (2012)")

```

Note that this is not a rectangular dataset in that Haggard and Kaufman's collection of clues was conditional on the outcome, $D=1$: they gathered qualitative data on the presence of international pressure and the presence of mass-mobilization *only* for those cases that democratized. This is not an uncommon case-selection principle. The analyst often reasons that more can be learned about how an outcome arises by focusing in on cases where the outcome of interest has in fact occurred. (We assess this case-selection intuition, in the context of model-based inferences, in Chapter \@ref(caseselection).)

The raw correlations between variables is shown in Table \@ref(tab:pimdcorr). Some correlations are missing because, as mentioned, data on some variables were only gathered conditional on the values of others. For those quantities where we do see correlations, they are not especially strong. There is, in particular, a weak overall relationship between inequality and democratization --- though, of course, this is consistent with inequality having heterogeneous effects across the sample. The strongest correlation in the data is between $P$ and $M$, which are assumed to be uncorrelated in the model, though this correlation is also quite weak.   

```{r pimdcorr, echo = FALSE, warning  = FALSE, message = FALSE}
kable(cor(data[,-1], use = "pairwise.complete.obs"), digits = 3)
kable(cor(data[,-1], use = "pairwise.complete.obs"), digits = 3)
```



## Inference

With data and model in hand, we can now update our model to get posteriors on the distribution $\lambda$ from which we can generate beliefs over all  causal relations. 
<!-- FLAG: Need to talk a bit through what's happening here.  -->

```{r ch9updatePIMD, include = FALSE}
if(do_diagnosis){
  model <- update_model(model, data)
  write_rds(model, "saved/PIMD_updated_2.rds")
  }

model <- read_rds("saved/PIMD_updated_2.rds")

```


:::: {.headerbox data-latex=""}
::: {.center data-latex=""}
:::

The code below shows how to defeine the Democratization model in `CausalQueries`.

The first line provides the DAG and indicated confounding between I and M. The second line imposes monotonicity restrictions. 

```{r modelblock, message = FALSE, echo = TRUE, eval = FALSE}
model <- 
  
  make_model("I -> M -> D <- P; I -> D; I <-> M") %>% 
  
  set_restrictions(c( 
           "(M[I=1] < M[I=0])", 
           "(D[I=1] > D[I=0]) | (D[M=1] < D[M=0]) | (D[P=1] < D[P=0])"))
  
```

We can then figure out the set of parameters needed to characterize all possible causal relations between these nodes that are consistent with the model. These parameters are used to specify a likelihood function, which, combined with priors on parameters and the data lets us update on the dsitribution of causal relations. In `CausalQueries` all this is done using `update_model()`.

```{r, eval = FALSE}

model <- update_model(model, data)
```

```{r dimparammatrix, include = FALSE}
param_mat <- get_parameter_matrix(model)
dim(param_mat)
```

::::
<br>

What do we find?

### Did inequality *cause* democracy?

We have used the data to update on $\lambda$: our beliefs about the distributions of nodal types, including about their joint distributions (i.e., confounding). 

One set of questions we can ask of the updated model is about the probability that high inequality causes democratization. We can pose this question at different levels of conditioning. For instance, we can ask:

1. **For all cases**. For what proportion of cases in the population does inequality have a positive effect on democratization? 

2. **For all cases displaying a given causal state and outcome**. Looking specifically at those cases that in fact had high inequality and democratized, for what proportion was the high inequality a cause of democratization?

3. **For cases displaying a given causal state and outcome, and with additional clues present or absent.** What if we have also collected clues on mediating or moderating nodes? For instance, for what proportion of high-inequality, democratizing cases *with* mobilization did inequality cause the outcome? For what proportion *without* mobilization? Likewise for the presence or absence of international pressure?

We ask `CausalQueries` now to query $\lambda$'s posterior distribution to generate posterior distributions for each of these quantities. We can define our queries quite simply in terms of the causal types that correspond to the effect of interest and then take the conditional probability of these. We present the code and results of these operations below and in Figure \@ref(fig:mixedhist).

In figure @\ref(fig:pimdqueries) we graph the priors for each of these queries next to the posteriors.

```{r pimdqueries, include = FALSE, echo = FALSE}

if(do_diagnosis){
pimd_queries <- list(
  #For what proportion of cases does inequality have a positive effect on democratization?
  prob_b = query_distribution(
    model = model,
    using = "posteriors",
    query = "D[I=1] > D[I=0]"
  ),
  
  #For what proportion of I=D=1 cases did inequality cause democratization?
  PC =  query_distribution(
    model = model,
    using = "posteriors",
    query = "D[I=1] > D[I=0]",
    given = "D==1 & I==1"
  ),
  
  #For what proportion  of I=M=D=1 cases did inequality cause democratization?
  PC2 = query_distribution(
    model = model,
    using = "posteriors",
    query = "D[I=1] > D[I=0]",
    given = "D==1 & I==1 & M==1"
  ),
  
  #And what about for the I=D=1 cases where there was no mobilization?
  PC3 = query_distribution(
    model = model,
    using = "posteriors",
    query = "D[I=1] > D[I=0]",
    given = "D==1 & I==1 & M==0"
  ),
  
  PC4 = query_distribution(
    model = model,
    using = "posteriors",
    query = "D[I=1] > D[I=0]",
    given = "D==1 & I==1 & M==1 & P==1"
  ),
  
  # And what about for the I=D=1 cases where there was no mobilization?
  PC5 = query_distribution(
    model = model,
    using = "posteriors",
    query = "D[I=1] > D[I=0]",
    given = "D==1 & I==1 & M==1 & P==0"
  )
)

write_rds(pimd_queries, "saved/09_qimdqueries_2.rds")
}


pimd_queries <- read_rds("saved/09_qimdqueries_2.rds")

```


```{r mixedhist, echo =FALSE, fig.cap = "Posteriors on Causes of Democratization"}

x <- lapply(pimd_queries, function(a) data.frame(p = as.vector(a))) %>%
  bind_rows(.id = "Q") %>%
  mutate(Q = factor(Q, c("prob_b", "PC", "PC2", "PC3", "PC4", "PC5"),
                    c("I=1 causes D=1", "D=1 caused by I=1", "D=1 caused by I=1 | M = 1", "D=1 caused by I=1 | M = 0", "D=1 caused by I=1 | M = 1, P=1",  "D=1 caused by I=1 | M = 1, P=0")))

x %>% ggplot(aes(p)) + geom_histogram() + facet_wrap(~Q, scales = "free_y") + theme_bw()  + xlim(-.1,1) + xlab("probability")
         
```

<!-- FLAG: Not sure how much it is worth saying here substantively about the results given how strongly they are driven by the restrictions. -->

```{r, echo = FALSE}


if(do_diagnosis){
pimd_queries_2 <- 
  
  model %>% 
  
  query_model(
    using = "posteriors",
    query = "D[I=1] > D[I=0]",
    given = c(TRUE, 
              "D==1 & I==1",  
              "D==1 & I==1 & M==1",
              "D==1 & I==1 & M==0",
              "D==1 & I==1 & M==1 & P==1",
              "D==1 & I==1 & M==1 & P==0")
)

write_rds(pimd_queries_2, "saved/09_pimdqueries_2.rds")
}

pimd_queries_2 <- read_rds("saved/09_pimdqueries_2.rds")

pimd_queries_2 %>% select(Given, mean, sd) %>% kable(digits = 2, caption = "Probability that inequality increases chances of democratization given:")

```
We can see that the share of cases overall in which inequality causes democratization is estimated to be very low, with a good deal of confidence. The proportion is considerably higher for those cases that in fact experienced high inequality and democratization. The proportion of positive causal effects is believed to be even higher for those in which mobilization occurred, especially where an alternative causes---international pressure---was absent, though our uncertainty about this share is also very high. We also see that the absence of mobilization tells us for certain that democratization was not caused by inequality. Interestingly, however, this result derives from the model restrictions, rather than from the data: under the restrictions we imposed, a positive effect of inequality could operate *only* through mobilization.


### Did inequality *prevent* democracy?

We can undertake the same exercise for a negative causal effect, generating estimates a comparable set of estimands, as shown in Figure \@ref(fig:mixedhist2).

```{r pimdnegqueries, include = FALSE, warning = FALSE}

if(do_diagnosis){
  
pimdneg_queries <- list(

  prob_a = query_distribution(
                   model = model, 
                   using = "posteriors",
                   query = "D[I=0] > D[I=1]"),

PCneg =  query_distribution(
                   model = model, 
                   using = "posteriors",
                   query = "D[I=0] > D[I=1]",
                   given = "D==0 & I==1"),

PC2neg = query_distribution(
                   model = model, 
                   using = "posteriors",
                   query = "D[I=0] > D[I=1]",
                   given = "D==0 & I==1 & M==1"),

PC3neg = query_distribution(
                   model = model, 
                   using = "posteriors",
                   query = "D[I=0] > D[I=1]",
                   given = "D==0 & I==1 & M==0"),

PC4neg = query_distribution(
                   model = model, 
                   using = "posteriors",
                   query = "D[I=0] > D[I=1]",
                   given = "D==0 & I==1 & M==1 & P==1"),

PC5neg = query_distribution(
                   model = model, 
                   using = "posteriors",
                   query = "D[I=0] > D[I=1]",
                   given = "D==0 & I==1 & M==0 & P==0"))

write_rds(pimdneg_queries, "saved/09_pimdnegqueries.rds")
}

```

```{r mixedhist2, echo =FALSE, fig.cap = "Posteriors on Causes of Democratization"}

read_rds("saved/09_pimdnegqueries.rds") %>%
  
  lapply(function(a) data.frame(p = as.vector(a))) %>%
  bind_rows(.id = "Q") %>%
  mutate(Q = factor(Q, 
                    c("prob_a", "PCneg", "PC2neg", "PC3neg", "PC4neg", "PC5neg"),
                    c("I=1 causes D=0", "D=0 caused by I=1", "D=0 caused by I=1 | M = 1", "D=0 caused by I=1 | M = 0", "D=0 caused by I=1 | M = 1, P=1",  "D=0 caused by I=1 | M = 1, P=0"))) %>% 
  ggplot(aes(p)) + 
  geom_histogram() + facet_wrap(~Q, scales = "free_y") + theme_bw()  + xlim(-.1,1) + xlab("probability")
         
```
```

We see that inequality appears, overall, more commonly to prevent democratization than to cause it. We are, moreover, most confident that inequality played a preventative role in those cases in which there was mobilization and international pressure---both of which *could* have generated democratization---but still no democratization occurred. 

Importantly, in the mixed-data setting, we can think of our estimands in both population-level and case-level terms. We have initialy posed these question as population-level queries. The results in Figures \@ref(fig:mixedhist) and \@ref(fig:mixedhist2) can be understood as our estimates of the *share* of cases in the population, with a given set of characteristics, for which a particular causal effect holds. Yet these distributions, by the very same token, represent our beliefs about the probability that $I$ had a positive causal effect in an individual case. Thus, for instance, from Figure \@ref(fig:mixedhist) we can see  the posterior on the proportion of $I=D=M=1$ cases in the population for which $I=1$ caused $D=1$. But this also tells us, for an individual case randomly selected from the population of $I=D=M=1$ cases, the probability that high inequality caused democratization in the case. The key difference from the pure process-tracing setup is that here our case-level inferences are informed by *data* from the population, rather than population-level beliefs serving only as priors.


```{r ppcomparison, include = FALSE}
# Estimands can be calculated for both the prior and posterior distributions.

model <- set_prior_distribution(model)

givens11 <- list(TRUE, "D==1 & I==1", "D==1 & I==1 & M ==1", "D==1 & I==1 & M==0")
givens01 <- list(TRUE, "D==0 & I==1", "D==0 & I==1 & M ==1", "D==0 & I==1 & M==0")

if(do_diagnosis){

model_prior <- update_model(model)  

ch09_queryresults <- list(
  
result_priors = query_model(
                   model = model_prior, 
                   using = "posteriors",
                   queries =  list("D[I=1] > D[I=0]"),
                   given = givens11),

result_posteriors = query_model(
                   model = model, 
                   using = "posteriors",
                   queries =  list("D[I=1] > D[I=0]"),
                   given = givens11),

prevent_priors = query_model(
                   model = model_prior, 
                   using = "posteriors",
                   queries =  list("D[I=0] > D[I=1]"),
                   given = givens01),

prevent_posteriors = query_model(
                   model = model, 
                   using = "posteriors",
                   queries =  list("D[I=0] > D[I=1]"),
                   given = givens01))

write_rds(ch09_queryresults, "saved/ch09_queryresultsqueries.rds")
}

ch09_queryresults_queries <- read_rds("saved/ch09_queryresultsqueries.rds")

pp_comparison <- ch09_queryresults_queries  %>% bind_rows(.id = "case") %>%
  mutate(using = ifelse(grepl("priors", case), "Priors", "Posteriors"),
         query = ifelse(grepl("result", case), "Caused", "Prevented"))
```

```{r dcaused, echo = FALSE, fig.cap = "Posteriors on the probability that inequality caused democratization (probability that I has a positive effect on D given observed case level data). The error bars show plus or minus one standard deviation of the posterior variance. "}

pp_comparison %>% filter(query == "Caused") %>% 
  ggplot(aes(mean, Given, color = using)) + 
  geom_point(position=position_dodge(.5)) + 
  theme_bw() +
  geom_errorbarh(aes(xmin=mean - sd, xmax=mean + sd), 
                size=.2, height = .1,
                position=position_dodge(.5))

```

```{r dprevented, echo = FALSE, fig.cap = "Posteriors on the probability that inequality prevented democratization (probability that I has a negative effect on D given observed case level data. The error bars show plus or minus one standard deviation of the posterior variance. )"}
pp_comparison %>% filter(query == "Prevented") %>% 
  ggplot(aes(mean, Given, color = using)) + 
  geom_point(position=position_dodge(.5)) + 
  theme_bw() +
  geom_errorbarh(aes(xmin=mean - sd, xmax=mean + sd), 
                size=.2, height = .1,
                position=position_dodge(.5))





```
The error bars show plus or minus one standard deviation of the posterior variance. We see that uncertainty is large and that the updating on probative value is small relative to mean inferneces.


