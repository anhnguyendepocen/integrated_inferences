# Going wide, going deep {#wideordeep}

```{r packagesusedwd, include = FALSE}
source("_packages_used.R")
do_diagnosis = FALSE
```

:::: {.headerbox data-latex=""}
::: {.center data-latex=""}
:::
As we have argued, we can use a causal model, together with priors over parameters, to estimate the expected learning from different empirical strategies. We have so far demonstrated this approach to research design for clue-selection and case-selection. In this chapter, we turn to the problem of choosing between going "wide" and going "deep." We discuss the tradeoffs and communicate an intuition that clue data, even on a small number of cases, can be informative even when there is $X, Y$ data on a very large number of cases, but only if it provides information that cannot be gathered from $X,Y$ data, such as selection into treatment. Simulations suggest that going deep is especially valuable for observational research, situations with homogeneous treatment effects, and, of course, when clues have strong probative value.
::::


We continue exploring how we can leverage causal models in making research-design choices by thinking about the tradeoff between intensive (deep) and extensive (wide) analysis. Suppose that we have identified those clues that will be most informative and those cases in which it would be most valuable to conduct process tracing, given our beliefs about the world. A further question that we face is the quintessential dilemma of *mixing* methods: what mixture of quantitative and qualitative evidence is optimal? We have argued in in Chapter \ref(mixing) that the distinction between quantitative and qualitative inference is, in a causal-model framework, without much of a difference. But here we frame a more precise question: given finite resources, how should we trade off between studying a larger number of cases at a given level of intensiveness, on the one hand, and drilling down to learn more intensively about some subset of the cases in our sample? How should we decide between going "wide" and going "deep"?

Just as with the selection of clues and cases, examined Chapters \@ref(clue) and \@ref(caseselection), how much we should expect to learn from going wide versus going deep will depend on how we think the world works, as expressed in the causal model with which we start and as shaped by the data that we have seen at the point of making the wide-versus-deep decision. 

We examine here queries commonly associated with large-$N$, quantitative strategies of analysis (such as average treatment effects) as well as queries commonly associated with more case-oriented, qualitative approaches (queries about causal pathways and about causal effects at the case level). The analysis in this chapter makes clear the opportunities for integration across these lines of inquiry. We show that investing in-depth process tracing will sometimes make sense even when one aims to learn about average effects in a population. Likewise, collecting $X, Y$ data can sometimes help us draw inferences that will aid in case-level explanation. Particular kinds of case-level information can teach us about populations, and understanding population-level patterns can help us get individual cases right. 


###  Walk-through of a simple comparison

To build up our intuitions about how the optimal mix of strategies might depend on how the world works, let us explore a simple comparison of wide and deep strategies. We focus here on the question of how much we can learn from drilling deeper, given an initial set of $X,Y$ data and beliefs about the world.

Imagine a world in which we have a large amount of data on $X$ and $Y$ (2000 observations), and we see that $X$ and $Y$ are perfectly correlated. We might be tempted to infer that $X$ causes $Y$. And, if $X$ were randomly assigned, then we might be able to justify that inference. Suppose, however, that our data is observational and, in particular, we were aware of an observed confound, $M$, that might determine both $X$ and $Y$. In that situation, the effect of $X$ on $Y$ is not identified. As shown by @manski1995identification,  different priors could support beliefs about that effect lying anywhere between 0 and 1. From @pearl2009causality's backdoor criterion, we also know that if the right causal model is $X \rightarrow Y \leftarrow M \rightarrow X$, then data on $M$ would allow the effect of $X$ on $Y$ to be identified. We could estimate the effect of $X$ on $Y$ for $M=0$ and for $M=1$ and take the average. 

Suppose now that we aim to collect additional data, but that data on $M$ for a single unit is far more costly than data on $X$ and $Y$ for a single unit. We thus face a choice between gathering *a lot* more data on $X$ and $Y$ (say, for 2000 more cases) or gathering a *little* data on $M$ for a subset of cases---just 20 in this illustration. Which should we do? Is 20 cases enough to probe the causal model to see whether the correlation between $X$ and $Y$ is spurious or not?

We get an intuition for the answer by imagining the inferences we might draw in 3 extreme cases and compare these to the base case. Figure \@ref(fig:widedeepXYMX) illustrates. The figures are generated by forming a model with $X\rightarrow Y \leftarrow M \rightarrow X$, strong priors that $\Pr(M=1)=0.5$, and flat priors on all other nodal types. In other words, in our priors we think that $M$ is equally likely to be a 0 or 1 but do not make assumptions about how it is related to $X$ and $Y$. We first update the model with the $X,Y$ data --- and then choose between going wider and going deeper. 




```{r widedeepXYMX, echo = FALSE, fig.width = 10, fig.height = 8, fig.cap = "Posteriors on the ATE given different wide or deep data patterns."}

if(do_diagnosis){
  
  M <- make_model("X -> Y <- M -> X") %>% set_priors(node = "M", alpha = 100)

  dfM2 <- dfM1 <- df <-
    data.frame(X = rep(0:1, 1000), Y = rep(0:1, 1000), M = NA)  
  
  dfM1$M[1:20] <- rep(0:1, each = 10)
  dfM2$M[1:20] <- rep(0:1)
  
  out <- list(
    base = update_model(M, df, keep_transformed = TRUE, iter = 5000) %>% 
      query_distribution("Y[X=1]  - Y[X=0]", using = "posteriors"),
    wide = update_model(M, rbind(df, df), keep_transformed = TRUE, iter = 5000) %>% 
      query_distribution("Y[X=1]  - Y[X=0]", using = "posteriors"),
    deep1 = update_model(M, dfM1, keep_transformed = TRUE, iter = 5000) %>% 
      query_distribution("Y[X=1]  - Y[X=0]", using = "posteriors"),
    deep2 = update_model(M, dfM2, keep_transformed = TRUE, iter = 5000) %>% 
      query_distribution("Y[X=1]  - Y[X=0]", using = "posteriors"),
        deep1check = update_model(M, dfM1[1:20,], keep_transformed = TRUE, iter = 5000) %>% 
      query_distribution("Y[X=1]  - Y[X=0]", using = "posteriors")
  )
  
  write_rds(out, "saved/ch13_wide_deep_histograms.rds")
  }

out <- read_rds("saved/ch13_wide_deep_histograms.rds")
par(mfrow = c(2,2))
hist(out[[1]], main = "(1) 2000 XY observations", xlab = "ATE", xlim = 0:1, freq = FALSE)
hist(out[[2]], main = "(2) Add another 2000 XY observations", xlab = "ATE", xlim = 0:1, freq = FALSE)
hist(out[[3]], main = "(3) Add 20 M observations (uncorrelated)", xlab = "ATE", xlim = 0:1, freq = FALSE)
hist(out[[4]], main = "(4) Add 20 M observations (correlated)", xlab = "ATE", xlim = 0:1, freq = FALSE)

```


Panel 1 in  Figure \@ref(fig:widedeepXYMX) shows our posterior distribution over the average causal effect from observation of the base data: 2000 cases with $X$ and $Y$ perfectly correlated. The distribution is quite wide, despite the strong correlation, because the posterior includes our uncertainty over the nature of confounding.  Our estimate for the $ATE$ is `r round(mean(out$base), 2)` but with a posterior standard deviation of  `r round(sd(out$base), 4)`. There is positive weight on all positive value of the $ATE$.

How can we improve on this estimate?

One possibility would be to go wide and collect $X,Y$ data on an additional 2000 cases. Panel 2 displays our posterior on the average causal effect with the addition of these 2000 cases. We assume that the new data also display a perfect $X,Y$ correlation, like the first set of data. Again, we could not imagine data that more strongly confirms a positive relation, and now we have twice as much of it. What we see, however, is that investing in gathering data on 2000 additional cases does not help us very much. The mean of our posterior on the $ATE$ is now `r round(mean(out$wide), 2)`, with a standard deviation of  `r round(sd(out$wide), 4)`. So the updating is very slight.

Suppose that, for the cost of gathering $X,Y$ data on an additional 2000 cases, we could drill down on a random subset of 20 of the original 2000 cases and observe $M$ in those cases. What might we learn? 

Because we start out with a flat prior on how $M$ will relate to $X$ and $Y$, we display inferences for two possible realizations of that pattern. In Panel 3, we show the updating if $M$ turns out to be uncorrelated with both $X$ and $Y$. The mean of our posterior on the $ATE$ now rises to `r round(mean(out$deep1), 2)`, and the posterior standard deviation shrinks dramatically, to  `r round(sd(out$deep1), 4)`. Greater depth in a relatively small number of cases is enough to convince us that the $X,Y$ relationship is not spurious.  

Panel 4 shows inferences from the same "going deep" strategy but where $M$ turns out to be perfectly correlated with $X$ and $Y$. Now our estimate for the $ATE$ shifts downward to `r round(mean(out$deep2), 2)`, with a posterior standard deviation of  `r round(sd(out$deep2), 4)`. 

In other words, in this setup, what we observe from our "going deep" strategy can have a big impact on our inferences. One reason we stand to learn so much from process-tracing so few cases is that the process-tracing speaks to relationships about which we start out knowing so little: $M$'s effect on $X$ and $M$'s effect on $Y$, effects on which the $X,Y$ data themselves shed no light. 

It is also interesting to note that we cannot learn as much by updating *only* using information from the 20 cases for which we have full $X$, $M$, $Y$ data. Were we to use only the subset with this complete data --- ignoring the other 1880 cases --- and observe $M$ to be uncorrelated with $X$ and $Y$, the mean of our posterior on the $ATE$ would be `r round(mean(out$deep1check), 2)` with a posterior standard deviation of  `r round(sd(out$deep1check), 4)` (not graphed). The breadth provided by those 1880 $X,Y$-only cases thus adds a great deal. While observing an uncorrelated $M$ in 20 cases allows us to largely rule out $M$ as a cause of any $X,Y$ correlation, observing a strong $X,Y$ correlation over a large number of cases provides evidence that $X$ in fact affects $Y$.

We use this example to illustrate a simple but stark point: there will be situations in which the expected gains from collecting more data on the same cases and from collecting the same data on more cases will be different, sometimes very different. The model and the prior data shape the tradeoff. In this particular setup, it is the confounding together with the large number of prior $X,Y$ observations that makes depth the better strategy. Once we have learned from 2000 $X,Y$ observations, data of the same form from more cases will not change beliefs. Yet going deep---even if only in a few cases---provides information on parameters we know nothing about, helping us interpret the $X,Y$ correlation in causal terms.


### A simulation-based approach to choosing mixes

While the results in the last section are striking, they depend upon particular realizations of the data under each strategy. When selecting strategies we, of course, do not know how the data will turn out. Our problem becomes, as in the case-selection analyses, one of figuring out the *expected posterior variance* from different strategies. 

<!-- ```{r morn1, fig.width = 6, fig.height = 5, echo = FALSE, message = FALSE, fig.cap = "Distributions of posterior variances from many simulated datasets"} -->
<!-- path = "rep/wide_deep_2" -->
<!-- results <-  -->
<!--   list( -->
<!--     Chain = read_rds(paste0(path, "/chain.rds")), -->
<!--     Confounded = read_rds(paste0(path, "/confounded.rds")), -->
<!--     Confounded_large_n = read_rds(paste0(path, "/confounded_large.rds")), -->
<!--     Restricted = read_rds(paste0(path, "/restricted.rds")), -->
<!--     Base = read_rds(paste0(path, "/base.rds")), -->
<!--     Chain_homogeneous = read_rds(paste0(path, "/chain_homog.rds")), -->
<!--     Chain_with_priors = read_rds(paste0(path, "/chain_with_prior.rds")) -->
<!-- ) %>% bind_rows(.id = "Model") %>% -->
<!--     mutate(Model = ifelse(Model == "Confounded_large_n", "Confounded", Model)) -->

<!-- r2 <- results %>% filter(Model == "Confounded" & wide_n %in% c(800, 1600) & deep_n %in% c(0, 100) & Case.estimand == "FALSE" & Given == "-") -->

<!-- r2 %>% -->
<!--   ggplot(aes(sd^2)) + -->
<!--   geom_histogram() +  -->
<!--   facet_grid(deep_n ~ wide_n, labeller = label_both) + xlab("Posterior variance on the ATE") -->
<!-- ``` -->


<!-- ```{r morn2, echo = FALSE, message = FALSE} -->
<!-- r2 %>% group_by(wide_n, deep_n) %>% summarize(expected = mean(sd^2))  %>% kable(caption = "Expected posterior variance on the ATE", digits = 4) -->

<!-- ``` -->


The more general, simulation-based approach that we introduce here is parallel to the approach for case-selection. The steps of this procedure are:

1. **Model**. We posit a causal model, with any priors or restrictions.
2. **Prior data**. We specify the data that we already have in hand. For the simulations below, we assume no prior data.
3. **Strategies**. We then specify a set of mixing strategies to assess. A strategy, in this context, is defined as any combination of collecting data on the same nodes for a given number of additional cases (randomly drawn from the population) and collecting data on new nodes for a random sample of the original set of cases.
4. **Data possibilities.** For each strategy, we define the set of possible data-realizations. Whereas for case-selection the structure of the possible data-realizations will be the same for all strategies of a given $N$, possible data patterns in wide-versus-deep analyses involve much greater complexity and will vary in structure across strategies. This is because the number of cases itself varies across strategies. Also, whereas we fix the $X,Y$ pattern for the purposes of case-selection, here we allow the $X,Y$ patterns we discover to vary across each simulation draw.
5. **Data probabilities**. As for case-selection, we use the model and prior data to calculate the probability of each data possibility under each strategy.
6. **Inference.** Again, as for case-selection, we update the model using each possible data pattern to derive a posterior distribution. 
7. **Expected posterior variance.** We then average the posterior distributions across the possible data patterns under a given strategy, weighted by the probability of each data pattern.

<!-- We illustrate the last two steps in Figure \@ref(fig:morn1), using a similar setup to the one above. We again posit the same $X \rightarrow Y \leftarrow M \rightarrow X$. We assume that we have started with $X,Y$ observations for 800 cases. We then choose among drawing another 800 cases for $X,Y$ analysis, going deeper in 100 of our cases, or both. What Figure \@ref(fig:morn1) shows is the distribution of *posterior variances* that we obtain from many possible data draws under each strategy.  In the top row, we are comparing two levels of breadth, with no depth. Moving to the bottom row, we introduce depth in 100 cases, for each level of breadth. We see here a distinct shift in the distributon to the left --- meaning, a reduction in the expected posterior variance -- when we drill down to gather data on $M$. In contrast, we see no such shift in the expected posterior variance when we increase the number of cases for which we gather data on $X$ and $Y$. For greater precision, we report the expected value for each distribution of posterior variances in Table \@ref(tab:morn2). The pattern here is consistent with the analysis above, although here we have averaged across all *possible* data patterns arising from the strategies, rather than focusing on just a couple of data possibilities.  -->

<!-- This approach can be applied to *any* model, with *any* query, and *any* prior set of data.  -->

#### Simulation results

We now explore alternative mixes of going wide and going deep for a range of models and queries, the same set that we examined for case-selection in Chapter \@ref(caseselection). We present the results in compact form in Figure \@ref(morn3). The structure of the panels is the same as those in the figure in Chapter \@ref(caseselection), with models being crossed with queries. Within each panel, each line represents going wide to a differing degree: collecting $X,Y$ data for $N=100$, for $N=400$, and for $N=1600$. As we move rightward along each line, we are adding depth: we show results for a strategy with no process-tracing, for process tracing 50 of the $X,Y$ cases, and for process-tracing 100 of the $X,Y$ cases. On the $y-$axis of each graph, we plot the expected posterior variance from each wide-deep combination.^[Note that the expected posterior variance is always $0$ for queries that are already answered with certainty by the model itself, such as the probability of a negative effect in a model with negative effects excluded.]

Looking at the figure as a whole, one pattern that leaps out is that there are, for almost all model-query combinations, gains from going wider. We can also see, unsurprisingly, that the marginal gains to going wide are diminishing. It is also interesting to note where going wider appears to add little or nothing: when we want to estimate the probability that a positive effect runs through the indirect path, we learn nothing from observing $X$ and $Y$ for a larger set of cases. 

Focusing just on the gains to depth, we see that these are much more concentrated in specific model-query combinations. Going deep to learn about the $ATE$ or the probability of positive or negative causation appears at best marginally advantageous --- at least up to $N=100$ --- for the unconstrained confounded and moderator models and for both unconstrained and monotonic two-path models. Notably, we *do* learn from going deep in both the unconstrained and monotonic chain models. As for going wide, the marginal gains from going deep are also diminishing, with the biggest gains arising from the first 50 cases in which we observe $M$.

Part of what is likely going on here is that unconstrained models are ones in which we start out with no information about $M$'s probative value. We can *learn* about $M$'s effects from observing $M$ (as discussed in Chapters \@ref(mixing) and \@ref(mixingapp)); this is why we can learn from process tracing in even the unconstrained version of the chain model. However, that learning gets much harder in unconstrained models with confounding or in models with two paths. In a confounded model, for instance, suppose we see $M$ positively correlated with $X$ and negatively correlated with $Y$, with $X$ and $Y$ themselves negatively correlated. This pattern is consistent with $M$ having a positive effect on $X$ and a negative effect on $Y$, and thus a high degree of confounding. But it is equally consistent with $M$ having only a positive effect on $X$ and $X$ having a negative effect on $Y$, with no $M \rightarrow Y$ effect and thus no confounding. A monotonicity assumption makes $M$ *a priori* informative: for instance, when we see $X=1, Y=1$, confounding is only a possibility if we also see $M=1$; confounding is ruled out if we observe $M=0$. 

In a two-path model, observing $M$ correlated with $X$ and with $Y$ across a set of cases should allow us to learn about $M$'s informativeness about the operation of an *indirect* effect, just as we can learn about $M$'s probative value in a chain model. The problem is that knowing about the indirect effect in a two-path model contributes only marginally to the first three queries in the figure since these are about total effects. Thus, even adding monotonicity restrictions, which makes $M$ *a priori* informative, does not significantly improve learning from $M$ about total effects.

The important exception, when it comes to learning about the two-path model, is when it is the *pathway itself* that we seek to learn about. As we can see in the figure, we can learn a great deal about whether effects operate via $M$ by observing $M$, even in an unconstrained two-path model. Interestingly, the gains from depth for causal-effect queries in an unconstrained chain model closely resemble the gains from depth for the indirect-effect query in the unconstrained two-path model. This similarity suggests that both kinds of model-query combinations allow for learning *about* $M$ that, in turn, permits learning *from* $M$. 

We also see that the context in which depth delivers the steepest gains of all is when we seek to learn about the probability of an indirect-effect in a monotonic two-path model. Part of the reason is likely that $M$ is *a priori* informative about the operation of the mediated pathway (as it is about the operation of effects in the monotonic chain model). Additionally, however, it appears that we start out with relatively high uncertainty about the pathway query because the model itself is quite uninformative about it. Thus, for instance, we learn much more from depth here than we do for a total effect query in a monotonic chain model: the monotonicity assumptions themselves already tell us a great deal about total effects, whereas they imply nothing about the path through which effects unfold. There is simply more to be learned from $M$ about pathways than about total effects.

Most interesting perhaps is using the graphs to examine different wide versus deep tradeoffs we might face. Suppose, for instance, that we wish to learn about the probability of negative causation in an unconstrained chain model for $X=0, Y=1$ cases. We start out with $X,Y$ data for 100 cases and have additional resources with which to collect more data. Let us further assume that the cost of collecting $X,Y$ data for an additional 300 cases is equal to the cost of collecting $M$ on 50 of the original 100 cases. Where whould we invest?

We can read a fairly clear answer off of the graph. As we can see in the relevant graph, we can expect to do better from adding depth than by adding breadth. In fact, even expanding our $X,Y$ sample to 1600 cases only gets us about as much leverage as get from process-tracing 50 cases.

We can also see how the optimal choice depends on what data-collection we have already committed to. Consider the probability of positive causation query for a monotonic confounded model. If we start with $X,Y$ data for 100 cases, we expect to gain more from going deep in 50 of these cases than from going wide to an additional 300. However, once we have decided to process-trace 50 cases, if we have additional resources, we then expect do be much better by investing in an expansion to 300 $X,Y$ cases than by process-tracing the other 50 $X,Y cases.

A further question we can ask is: where is mixing methods advantageous? And where are maximally wide or maximally deep strategies best? We see some places where we are better off going as wide as possible than going as deep as possible (for the ranges we explore in these simulations). For instance, if we wish to estimate the $ATE$ in a chain model (unconstrained or monotonic), we do substantially better with 1600 $X,Y$ cases than with observing all three nodes for 100 cases.






For the purposes of this illustration, we focus on the $ATE$ and the probability of positive causation as queries, and the results of the exercise would likely differ for different queries. On each graph, we plot 3 lines, each representing a different number of "wide" ($X,Y$-data only) cases, ranging from 100 to 1600. Each line then shows how the expected posterior variance changes as we add "depth," going from observing $M$ in 0 cases to observing it in 50 and then 100 cases.

Starting with the chain model ($X \rightarrow Y$), we see that there are gains to be reaped from both breadth and depth, for both queries. We can also get a sense of the nature of the tradeoffs. One thing we observe is that, for the $ATE$, the gains to breadth are greater the less depth we have. Once we have process-traced 100 cases, the difference in the posterior variance we expect between having $X,Y$ data only on those 100 cases and having $X,Y$ data on an additional 300 cases is very modest compared to the situation in which we have done no process tracing. Likewise, the gains to depth diminish with breadth: the slope of the depth line flattens as we add $X,Y$ cases. Further, there appear to be diminishing returns to each strategy on its own terms: note, for instance, how the move from 50 to 100 process-tracing cases deliver less expected learning than does the move from 0 to 50.

We can also how the tradeoff varies by estimand. For the $ATE$, the gains to going deep in an additional 50 cases look roughly equivalent to those of expanding the dataset by 100 cases. However, for the probability of positive causation, the scales tip quite dramatically in favor of depth: The gains to depth in 50 cases are more than double the gains of broadening by as many as 300 cases. 

```{r morn3, fig.width = 10, fig.height = 7, echo = FALSE, message = FALSE, fig.cap = "Expected posterior variance over multiple models with multiple data strategies."}

read_rds("saved/wide_deep_fig_book.rds")

```


 
In the chain model we see similar posterior variance from the following three strategies: 

1. Wide: 400w
2. Deep: 100w + 100d
3. Mixed: 200w + 50 d

For difference prices of $m$ and $d$ any of these may be best. In particular if the cost of w is $1: 

* strategy 2, mixed is better if deep costs between $2 and $4
* if deep costs more than $4 then go all wide
* If deep costs < $2 then go all deep


Common set

* Chain
* Chain monotonic
* Moderator
* Moderator monotonic
* Two path
* Two path monotonic
* Confounded
* Confounded monotonic

Mediation estimand for two path models

## Principles

*  Qualitative and quantitative data can act as partial substitutes for assessing causal effects.
*  The *relative* marginal gains from going wider and going deeper vary with the study design. 
* Optimal strategies might involve going deep in a subsample of cases only.




